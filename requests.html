<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            color: #333;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .logout-btn, .refresh-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .refresh-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .logout-btn:hover, .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-card.pending {
            border-top: 4px solid #f39c12;
        }

        .stat-card.approved {
            border-top: 4px solid #27ae60;
        }

        .stat-card.rejected {
            border-top: 4px solid #e74c3c;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-number.pending { color: #f39c12; }
        .stat-number.approved { color: #27ae60; }
        .stat-number.rejected { color: #e74c3c; }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Search & Filter */
        .search-section {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-input, .filter-select {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
        }

        .search-input:focus, .filter-select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        /* Requests Table */
        .requests-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .requests-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .requests-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 12px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }

        .requests-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
            font-size: 13px;
        }

        .requests-table tr:hover {
            background-color: #f8f9fa;
        }

        /* Request Cards for Mobile */
        .request-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .request-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .request-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .info-label {
            color: #666;
            font-weight: 600;
        }

        .info-value {
            color: #333;
        }

        /* Action Buttons */
        .actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-accept {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-reject {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-view {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* Status Badge */
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .status-pending {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        /* Loading & Empty States */
        .loading-state, .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Success/Error Messages */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .message.show {
            transform: translateX(0);
        }

        .message.success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .message.error {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
            
            .search-section {
                flex-direction: column;
            }
            
            .search-input {
                min-width: auto;
            }
            
            .requests-table {
                display: none;
            }
            
            .request-card {
                display: block;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container > * {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
            <div class="header-actions">
                <button class="refresh-btn" onclick="refreshData()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card pending">
                <div class="stat-number pending" id="pendingCount">0</div>
                <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</div>
            </div>
            <div class="stat-card approved">
                <div class="stat-number approved" id="approvedCount">0</div>
                <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù…Ù‚Ø¨ÙˆÙ„Ø©</div>
            </div>
            <div class="stat-card rejected">
                <div class="stat-number rejected" id="rejectedCount">0</div>
                <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù…Ø±ÙÙˆØ¶Ø©</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Search & Filter -->
            <div class="search-section">
                <input type="text" class="search-input" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." id="searchInput">
                <select class="filter-select" id="governorateFilter">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</option>
                    <option value="Ø¹Ù…Ø§Ù†">Ø¹Ù…Ø§Ù†</option>
                    <option value="Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡">Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡</option>
                    <option value="Ø¥Ø±Ø¨Ø¯">Ø¥Ø±Ø¨Ø¯</option>
                    <option value="Ø§Ù„Ø¨Ù„Ù‚Ø§Ø¡">Ø§Ù„Ø¨Ù„Ù‚Ø§Ø¡</option>
                    <option value="Ø§Ù„Ù…ÙØ±Ù‚">Ø§Ù„Ù…ÙØ±Ù‚</option>
                    <option value="Ø§Ù„ÙƒØ±Ùƒ">Ø§Ù„ÙƒØ±Ùƒ</option>
                    <option value="Ù…Ø¹Ø§Ù†">Ù…Ø¹Ø§Ù†</option>
                    <option value="Ø§Ù„Ø·ÙÙŠÙ„Ø©">Ø§Ù„Ø·ÙÙŠÙ„Ø©</option>
                    <option value="Ø§Ù„Ø¹Ù‚Ø¨Ø©">Ø§Ù„Ø¹Ù‚Ø¨Ø©</option>
                    <option value="Ø§Ù„Ø³Ù„Ø·">Ø§Ù„Ø³Ù„Ø·</option>
                    <option value="Ù…Ø§Ø¯Ø¨Ø§">Ù…Ø§Ø¯Ø¨Ø§</option>
                </select>
                <select class="filter-select" id="statusFilter">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                    <option value="pending">Ù…Ø¹Ù„Ù‚</option>
                    <option value="approved">Ù…Ù‚Ø¨ÙˆÙ„</option>
                    <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
                </select>
            </div>

            <!-- Requests Section -->
            <div class="requests-section">
                <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
                
                <!-- Loading State -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner"></div>
                    <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h3>
                    <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
                </div>
                
                <!-- Desktop Table -->
                <table class="requests-table" id="requestsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ù…Ù‡Ù†Ø©</th>
                            <th>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</th>
                            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTableBody">
                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ -->
                    </tbody>
                </table>

                <!-- Mobile Cards -->
                <div id="requestsCardView">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù‡Ù†Ø§ -->
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="icon">ğŸ“‹</div>
                    <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</h3>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Configuration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            setDoc, 
            deleteDoc,
            getDoc,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCj5YjdiruBTCfxDnxlDd4W6YA5iCWRfE4",
            authDomain: "home-services-app-a9c5e.firebaseapp.com",
            projectId: "home-services-app-a9c5e",
            storageBucket: "home-services-app-a9c5e.appspot.com",
            messagingSenderId: "287028219636",
            appId: "1:287028219636:web:2ad4b0e092a2c007e318a1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allRequests = [];
        let filteredRequests = [];

        // Check admin authentication
        const isAdmin = sessionStorage.getItem("adminLoggedIn");
        if (!isAdmin || isAdmin !== "true") {
            window.location.href = "admin-login.html";
        }

        // DOM Elements
        const elements = {
            loadingState: document.getElementById('loadingState'),
            requestsTable: document.getElementById('requestsTable'),
            requestsTableBody: document.getElementById('requestsTableBody'),
            requestsCardView: document.getElementById('requestsCardView'),
            emptyState: document.getElementById('emptyState'),
            pendingCount: document.getElementById('pendingCount'),
            approvedCount: document.getElementById('approvedCount'),
            rejectedCount: document.getElementById('rejectedCount'),
            searchInput: document.getElementById('searchInput'),
            governorateFilter: document.getElementById('governorateFilter'),
            statusFilter: document.getElementById('statusFilter')
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©...');
            await loadAllData();
            setupEventListeners();
            renderRequests();
        });

        function setupEventListeners() {
            elements.searchInput.addEventListener('input', debounce(filterRequests, 300));
            elements.governorateFilter.addEventListener('change', filterRequests);
            elements.statusFilter.addEventListener('change', filterRequests);
        }

        async function loadAllData() {
            try {
                showLoading(true);
                console.log('ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...');

                // Load all collections
                const [pendingSnapshot, approvedSnapshot, rejectedSnapshot] = await Promise.all([
                    getDocs(collection(db, "pendingUsers")),
                    getDocs(collection(db, "approvedUsers")),
                    getDocs(collection(db, "rejectedUsers"))
                ]);

                allRequests = [];

                // Process pending users
                pendingSnapshot.forEach((doc) => {
                    allRequests.push({ 
                        id: doc.id, 
                        ...doc.data(), 
                        status: 'pending' 
                    });
                });

                // Process approved users
                approvedSnapshot.forEach((doc) => {
                    allRequests.push({ 
                        id: doc.id, 
                        ...doc.data(), 
                        status: 'approved' 
                    });
                });

                // Process rejected users
                rejectedSnapshot.forEach((doc) => {
                    allRequests.push({ 
                        id: doc.id, 
                        ...doc.data(), 
                        status: 'rejected' 
                    });
                });

                filteredRequests = [...allRequests];
                updateStats();
                
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allRequests.length} Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`);
                showMessage('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
            } finally {
                showLoading(false);
            }
        }

        function updateStats() {
            const pending = allRequests.filter(r => r.status === 'pending').length;
            const approved = allRequests.filter(r => r.status === 'approved').length;
            const rejected = allRequests.filter(r => r.status === 'rejected').length;

            elements.pendingCount.textContent = pending;
            elements.approvedCount.textContent = approved;
            elements.rejectedCount.textContent = rejected;
        }

        function filterRequests() {
            const searchTerm = elements.searchInput.value.toLowerCase().trim();
            const governorateFilter = elements.governorateFilter.value;
            const statusFilter = elements.statusFilter.value;

            filteredRequests = allRequests.filter(request => {
                const matchesSearch = !searchTerm || 
                    (request.name && request.name.toLowerCase().includes(searchTerm)) ||
                    (request.phone && request.phone.includes(searchTerm)) ||
                    (request.job && request.job.toLowerCase().includes(searchTerm));
                
                const matchesGovernorate = !governorateFilter || request.city === governorateFilter;
                const matchesStatus = !statusFilter || request.status === statusFilter;

                return matchesSearch && matchesGovernorate && matchesStatus;
            });

            renderRequests();
        }

        function renderRequests() {
            const tableBody = elements.requestsTableBody;
            const cardView = elements.requestsCardView;
            
            // Clear existing content
            tableBody.innerHTML = '';
            cardView.innerHTML = '';

            if (filteredRequests.length === 0) {
                showEmptyState();
                return;
            }

            hideEmptyState();

            filteredRequests.forEach(request => {
                // Desktop table row
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${request.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong></td>
                    <td>${request.job || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td>${request.city || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td>${request.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td>${formatDate(request.createdAt)}</td>
                    <td><span class="status-badge status-${request.status}">${getStatusText(request.status)}</span></td>
                    <td>
                        <div class="actions">
                            ${request.status === 'pending' ? `
                                <button class="btn btn-accept" onclick="acceptRequest('${request.id}')">Ù‚Ø¨ÙˆÙ„</button>
                                <button class="btn btn-reject" onclick="rejectRequest('${request.id}')">Ø±ÙØ¶</button>
                            ` : ''}
                            <button class="btn btn-view" onclick="viewRequest('${request.id}')">Ø¹Ø±Ø¶</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);

                // Mobile card
                const card = document.createElement('div');
                card.className = 'request-card';
                card.innerHTML = `
                    <h3>${request.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</h3>
                    <div class="request-info">
                        <div><span class="info-label">Ø§Ù„Ù…Ù‡Ù†Ø©:</span> <span class="info-value">${request.job || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span></div>
                        <div><span class="info-label">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</span> <span class="info-value">${request.city || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span></div>
                        <div><span class="info-label">Ø§Ù„Ù‡Ø§ØªÙ:</span> <span class="info-value">${request.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span></div>
                        <div><span class="info-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span class="info-value">${formatDate(request.createdAt)}</span></div>
                        <div><span class="info-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span> <span class="info-value">${getStatusText(request.status)}</span></div>
                    </div>
                    <div class="actions">
                        ${request.status === 'pending' ? `
                            <button class="btn btn-accept" onclick="acceptRequest('${request.id}')">Ù‚Ø¨ÙˆÙ„</button>
                            <button class="btn btn-reject" onclick="rejectRequest('${request.id}')">Ø±ÙØ¶</button>
                        ` : ''}
                        <button class="btn btn-view" onclick="viewRequest('${request.id}')">Ø¹Ø±Ø¶</button>
                    </div>
                `;
                cardView.appendChild(card);
            });
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else {
                date = new Date(timestamp);
            }
            
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Ù…Ø¹Ù„Ù‚',
                'approved': 'Ù…Ù‚Ø¨ÙˆÙ„',
                'rejected': 'Ù…Ø±ÙÙˆØ¶'
            };
            return statusMap[status] || status;
        }

        function showLoading(show) {
            elements.loadingState.style.display = show ? 'block' : 'none';
            elements.requestsTable.style.display = show ? 'none' : 'table';
        }

        function showEmptyState() {
            elements.emptyState.style.display = 'block';
            elements.requestsTable.style.display = 'none';
        }

        function hideEmptyState() {
            elements.emptyState.style.display = 'none';
            elements.requestsTable.style.display = 'table';
        }

        function showMessage(title, message, type) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.innerHTML = `<strong>${title}:</strong> ${message}`;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => messageEl.classList.add('show'), 100);
            
            setTimeout(() => {
                messageEl.classList.remove('show');
                setTimeout(() => document.body.removeChild(messageEl), 300);
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Global Functions
        window.acceptRequest = async function(nationalId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‚Ø¨ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) {
                try {
                    showMessage('Ù…Ø¹Ø§Ù„Ø¬Ø©', 'Ø¬Ø§Ø±ÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨...', 'success');
                    
                    const pendingDoc = await getDoc(doc(db, "pendingUsers", nationalId));
                    
                    if (pendingDoc.exists()) {
                        const userData = pendingDoc.data();
                        
                        // Move to approved users
                        await setDoc(doc(db, "approvedUsers", nationalId), {
                            ...userData,
                            status: 'available',
                            approvedAt: serverTimestamp(),
                            lastUpdated: serverTimestamp()
                        });
                        
                        // Remove from pending users
                        await deleteDoc(doc(db, "pendingUsers", nationalId));
                        
                        showMessage('Ù†Ø¬Ø­', 'ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                        await loadAllData();
                        renderRequests();
                    }
                } catch (error) {
                    console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨:", error);
                    showMessage('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨', 'error');
                }
            }
        }

        window.rejectRequest = async function(nationalId) {
            const reason = prompt('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:');
            
            if (reason && reason.trim() !== '') {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¶ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) {
                    try {
                        showMessage('Ù…Ø¹Ø§Ù„Ø¬Ø©', 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨...', 'success');
                        
                        const pendingDoc = await getDoc(doc(db, "pendingUsers", nationalId));
                        
                        if (pendingDoc.exists()) {
                            const userData = pendingDoc.data();
                            
                            // Move to rejected users
                            await setDoc(doc(db, "rejectedUsers", nationalId), {
                                ...userData,
                                status: 'rejected',
                                reason: reason.trim(),
                                rejectedAt: serverTimestamp(),
                                lastUpdated: serverTimestamp()
                            });
                            
                            // Remove from pending users
                            await deleteDoc(doc(db, "pendingUsers", nationalId));
                            
                            showMessage('ØªÙ…', 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨', 'success');
                            await loadAllData();
                            renderRequests();
                        }
                    } catch (error) {
                        console.error("Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨:", error);
                        showMessage('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨', 'error');
                    }
                }
            } else if (reason !== null) {
                showMessage('Ù…Ø·Ù„ÙˆØ¨', 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶', 'error');
            }
        }

        window.viewRequest = function(nationalId) {
            const request = allRequests.find(r => r.id === nationalId);
            if (request) {
                const details = `
ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:
================
Ø§Ù„Ø§Ø³Ù…: ${request.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ù…Ù‡Ù†Ø©: ${request.job || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©: ${request.city || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ù‡Ø§ØªÙ: ${request.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ø¨Ø±ÙŠØ¯: ${request.email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ: ${request.nationalId || request.id}
Ø§Ù„ÙˆØµÙ: ${request.bio || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}
ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…: ${formatDate(request.createdAt)}
Ø§Ù„Ø­Ø§Ù„Ø©: ${getStatusText(request.status)}
${request.reason ? `Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶: ${request.reason}` : ''}
                `;
                alert(details);
            } else {
                showMessage('Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨', 'error');
            }
        }

        window.refreshData = async function() {
            showMessage('ØªØ­Ø¯ÙŠØ«', 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'success');
            await loadAllData();
            renderRequests();
        }

        window.logout = function() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                sessionStorage.removeItem("adminLoggedIn");
                sessionStorage.removeItem("adminLoginTime");
                showMessage('ØªÙ…', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                setTimeout(() => {
                    window.location.href = 'admin-login.html';
                }, 1500);
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(async () => {
            try {
                await loadAllData();
                renderRequests();
                console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:', error);
            }
        }, 30000);

        console.log('âœ… Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¬Ø§Ù‡Ø²Ø©');
    </script>
</body>
</html>