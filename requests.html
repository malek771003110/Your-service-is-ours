<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الطلبات - لوحة التحكم</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            color: #333;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .logout-btn, .refresh-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .refresh-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .logout-btn:hover, .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-card.pending {
            border-top: 4px solid #f39c12;
        }

        .stat-card.approved {
            border-top: 4px solid #27ae60;
        }

        .stat-card.rejected {
            border-top: 4px solid #e74c3c;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-number.pending { color: #f39c12; }
        .stat-number.approved { color: #27ae60; }
        .stat-number.rejected { color: #e74c3c; }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Search & Filter */
        .search-section {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-input, .filter-select {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
        }

        .search-input:focus, .filter-select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        /* Requests Table */
        .requests-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .requests-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .requests-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 12px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }

        .requests-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
            font-size: 13px;
        }

        .requests-table tr:hover {
            background-color: #f8f9fa;
        }

        /* Request Cards for Mobile */
        .request-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .request-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .request-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .info-label {
            color: #666;
            font-weight: 600;
        }

        .info-value {
            color: #333;
        }

        /* Action Buttons */
        .actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-accept {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-reject {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-view {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* Status Badge */
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .status-pending {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        /* Loading & Empty States */
        .loading-state, .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Success/Error Messages */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .message.show {
            transform: translateX(0);
        }

        .message.success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .message.error {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
            
            .search-section {
                flex-direction: column;
            }
            
            .search-input {
                min-width: auto;
            }
            
            .requests-table {
                display: none;
            }
            
            .request-card {
                display: block;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container > * {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🛠️ لوحة إدارة الطلبات</h1>
            <div class="header-actions">
                <button class="refresh-btn" onclick="refreshData()">🔄 تحديث</button>
                <button class="logout-btn" onclick="logout()">خروج</button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card pending">
                <div class="stat-number pending" id="pendingCount">0</div>
                <div class="stat-label">طلبات معلقة</div>
            </div>
            <div class="stat-card approved">
                <div class="stat-number approved" id="approvedCount">0</div>
                <div class="stat-label">طلبات مقبولة</div>
            </div>
            <div class="stat-card rejected">
                <div class="stat-number rejected" id="rejectedCount">0</div>
                <div class="stat-label">طلبات مرفوضة</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Search & Filter -->
            <div class="search-section">
                <input type="text" class="search-input" placeholder="🔍 البحث بالاسم أو الهاتف..." id="searchInput">
                <select class="filter-select" id="governorateFilter">
                    <option value="">جميع المحافظات</option>
                    <option value="عمان">عمان</option>
                    <option value="الزرقاء">الزرقاء</option>
                    <option value="إربد">إربد</option>
                    <option value="البلقاء">البلقاء</option>
                    <option value="المفرق">المفرق</option>
                    <option value="الكرك">الكرك</option>
                    <option value="معان">معان</option>
                    <option value="الطفيلة">الطفيلة</option>
                    <option value="العقبة">العقبة</option>
                    <option value="السلط">السلط</option>
                    <option value="مادبا">مادبا</option>
                </select>
                <select class="filter-select" id="statusFilter">
                    <option value="">جميع الحالات</option>
                    <option value="pending">معلق</option>
                    <option value="approved">مقبول</option>
                    <option value="rejected">مرفوض</option>
                </select>
            </div>

            <!-- Requests Section -->
            <div class="requests-section">
                <h2>📋 قائمة الطلبات</h2>
                
                <!-- Loading State -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner"></div>
                    <h3>جاري تحميل البيانات...</h3>
                    <p>يرجى الانتظار</p>
                </div>
                
                <!-- Desktop Table -->
                <table class="requests-table" id="requestsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>المهنة</th>
                            <th>المحافظة</th>
                            <th>الهاتف</th>
                            <th>التاريخ</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTableBody">
                        <!-- سيتم ملء البيانات هنا -->
                    </tbody>
                </table>

                <!-- Mobile Cards -->
                <div id="requestsCardView">
                    <!-- سيتم ملء البطاقات هنا -->
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="icon">📋</div>
                    <h3>لا توجد طلبات</h3>
                    <p>لا توجد طلبات حالياً أو لا توجد نتائج تطابق البحث</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Configuration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            setDoc, 
            deleteDoc,
            getDoc,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCj5YjdiruBTCfxDnxlDd4W6YA5iCWRfE4",
            authDomain: "home-services-app-a9c5e.firebaseapp.com",
            projectId: "home-services-app-a9c5e",
            storageBucket: "home-services-app-a9c5e.appspot.com",
            messagingSenderId: "287028219636",
            appId: "1:287028219636:web:2ad4b0e092a2c007e318a1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allRequests = [];
        let filteredRequests = [];

        // Check admin authentication
        const isAdmin = sessionStorage.getItem("adminLoggedIn");
        if (!isAdmin || isAdmin !== "true") {
            window.location.href = "admin-login.html";
        }

        // DOM Elements
        const elements = {
            loadingState: document.getElementById('loadingState'),
            requestsTable: document.getElementById('requestsTable'),
            requestsTableBody: document.getElementById('requestsTableBody'),
            requestsCardView: document.getElementById('requestsCardView'),
            emptyState: document.getElementById('emptyState'),
            pendingCount: document.getElementById('pendingCount'),
            approvedCount: document.getElementById('approvedCount'),
            rejectedCount: document.getElementById('rejectedCount'),
            searchInput: document.getElementById('searchInput'),
            governorateFilter: document.getElementById('governorateFilter'),
            statusFilter: document.getElementById('statusFilter')
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 تهيئة لوحة الإدارة...');
            await loadAllData();
            setupEventListeners();
            renderRequests();
        });

        function setupEventListeners() {
            elements.searchInput.addEventListener('input', debounce(filterRequests, 300));
            elements.governorateFilter.addEventListener('change', filterRequests);
            elements.statusFilter.addEventListener('change', filterRequests);
        }

        async function loadAllData() {
            try {
                showLoading(true);
                console.log('📥 جاري تحميل البيانات من Firebase...');

                // Load all collections
                const [pendingSnapshot, approvedSnapshot, rejectedSnapshot] = await Promise.all([
                    getDocs(collection(db, "pendingUsers")),
                    getDocs(collection(db, "approvedUsers")),
                    getDocs(collection(db, "rejectedUsers"))
                ]);

                allRequests = [];

                // Process pending users
                pendingSnapshot.forEach((doc) => {
                    allRequests.push({ 
                        id: doc.id, 
                        ...doc.data(), 
                        status: 'pending' 
                    });
                });

                // Process approved users
                approvedSnapshot.forEach((doc) => {
                    allRequests.push({ 
                        id: doc.id, 
                        ...doc.data(), 
                        status: 'approved' 
                    });
                });

                // Process rejected users
                rejectedSnapshot.forEach((doc) => {
                    allRequests.push({ 
                        id: doc.id, 
                        ...doc.data(), 
                        status: 'rejected' 
                    });
                });

                filteredRequests = [...allRequests];
                updateStats();
                
                console.log(`✅ تم تحميل ${allRequests.length} طلب بنجاح`);
                showMessage('تم التحديث', 'تم تحميل البيانات بنجاح', 'success');

            } catch (error) {
                console.error('❌ خطأ في تحميل البيانات:', error);
                showMessage('خطأ في التحميل', 'فشل في تحميل البيانات من الخادم', 'error');
            } finally {
                showLoading(false);
            }
        }

        function updateStats() {
            const pending = allRequests.filter(r => r.status === 'pending').length;
            const approved = allRequests.filter(r => r.status === 'approved').length;
            const rejected = allRequests.filter(r => r.status === 'rejected').length;

            elements.pendingCount.textContent = pending;
            elements.approvedCount.textContent = approved;
            elements.rejectedCount.textContent = rejected;
        }

        function filterRequests() {
            const searchTerm = elements.searchInput.value.toLowerCase().trim();
            const governorateFilter = elements.governorateFilter.value;
            const statusFilter = elements.statusFilter.value;

            filteredRequests = allRequests.filter(request => {
                const matchesSearch = !searchTerm || 
                    (request.name && request.name.toLowerCase().includes(searchTerm)) ||
                    (request.phone && request.phone.includes(searchTerm)) ||
                    (request.job && request.job.toLowerCase().includes(searchTerm));
                
                const matchesGovernorate = !governorateFilter || request.city === governorateFilter;
                const matchesStatus = !statusFilter || request.status === statusFilter;

                return matchesSearch && matchesGovernorate && matchesStatus;
            });

            renderRequests();
        }

        function renderRequests() {
            const tableBody = elements.requestsTableBody;
            const cardView = elements.requestsCardView;
            
            // Clear existing content
            tableBody.innerHTML = '';
            cardView.innerHTML = '';

            if (filteredRequests.length === 0) {
                showEmptyState();
                return;
            }

            hideEmptyState();

            filteredRequests.forEach(request => {
                // Desktop table row
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${request.name || 'غير محدد'}</strong></td>
                    <td>${request.job || 'غير محدد'}</td>
                    <td>${request.city || 'غير محدد'}</td>
                    <td>${request.phone || 'غير محدد'}</td>
                    <td>${formatDate(request.createdAt)}</td>
                    <td><span class="status-badge status-${request.status}">${getStatusText(request.status)}</span></td>
                    <td>
                        <div class="actions">
                            ${request.status === 'pending' ? `
                                <button class="btn btn-accept" onclick="acceptRequest('${request.id}')">قبول</button>
                                <button class="btn btn-reject" onclick="rejectRequest('${request.id}')">رفض</button>
                            ` : ''}
                            <button class="btn btn-view" onclick="viewRequest('${request.id}')">عرض</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);

                // Mobile card
                const card = document.createElement('div');
                card.className = 'request-card';
                card.innerHTML = `
                    <h3>${request.name || 'غير محدد'}</h3>
                    <div class="request-info">
                        <div><span class="info-label">المهنة:</span> <span class="info-value">${request.job || 'غير محدد'}</span></div>
                        <div><span class="info-label">المحافظة:</span> <span class="info-value">${request.city || 'غير محدد'}</span></div>
                        <div><span class="info-label">الهاتف:</span> <span class="info-value">${request.phone || 'غير محدد'}</span></div>
                        <div><span class="info-label">التاريخ:</span> <span class="info-value">${formatDate(request.createdAt)}</span></div>
                        <div><span class="info-label">الحالة:</span> <span class="info-value">${getStatusText(request.status)}</span></div>
                    </div>
                    <div class="actions">
                        ${request.status === 'pending' ? `
                            <button class="btn btn-accept" onclick="acceptRequest('${request.id}')">قبول</button>
                            <button class="btn btn-reject" onclick="rejectRequest('${request.id}')">رفض</button>
                        ` : ''}
                        <button class="btn btn-view" onclick="viewRequest('${request.id}')">عرض</button>
                    </div>
                `;
                cardView.appendChild(card);
            });
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'غير محدد';
            
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else {
                date = new Date(timestamp);
            }
            
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'معلق',
                'approved': 'مقبول',
                'rejected': 'مرفوض'
            };
            return statusMap[status] || status;
        }

        function showLoading(show) {
            elements.loadingState.style.display = show ? 'block' : 'none';
            elements.requestsTable.style.display = show ? 'none' : 'table';
        }

        function showEmptyState() {
            elements.emptyState.style.display = 'block';
            elements.requestsTable.style.display = 'none';
        }

        function hideEmptyState() {
            elements.emptyState.style.display = 'none';
            elements.requestsTable.style.display = 'table';
        }

        function showMessage(title, message, type) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.innerHTML = `<strong>${title}:</strong> ${message}`;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => messageEl.classList.add('show'), 100);
            
            setTimeout(() => {
                messageEl.classList.remove('show');
                setTimeout(() => document.body.removeChild(messageEl), 300);
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Global Functions
        window.acceptRequest = async function(nationalId) {
            if (confirm('هل أنت متأكد من قبول هذا الطلب؟')) {
                try {
                    showMessage('معالجة', 'جاري قبول الطلب...', 'success');
                    
                    const pendingDoc = await getDoc(doc(db, "pendingUsers", nationalId));
                    
                    if (pendingDoc.exists()) {
                        const userData = pendingDoc.data();
                        
                        // Move to approved users
                        await setDoc(doc(db, "approvedUsers", nationalId), {
                            ...userData,
                            status: 'available',
                            approvedAt: serverTimestamp(),
                            lastUpdated: serverTimestamp()
                        });
                        
                        // Remove from pending users
                        await deleteDoc(doc(db, "pendingUsers", nationalId));
                        
                        showMessage('نجح', 'تم قبول الطلب بنجاح!', 'success');
                        await loadAllData();
                        renderRequests();
                    }
                } catch (error) {
                    console.error("خطأ في قبول الطلب:", error);
                    showMessage('خطأ', 'فشل في قبول الطلب', 'error');
                }
            }
        }

        window.rejectRequest = async function(nationalId) {
            const reason = prompt('يرجى إدخال سبب الرفض:');
            
            if (reason && reason.trim() !== '') {
                if (confirm('هل أنت متأكد من رفض هذا الطلب؟')) {
                    try {
                        showMessage('معالجة', 'جاري رفض الطلب...', 'success');
                        
                        const pendingDoc = await getDoc(doc(db, "pendingUsers", nationalId));
                        
                        if (pendingDoc.exists()) {
                            const userData = pendingDoc.data();
                            
                            // Move to rejected users
                            await setDoc(doc(db, "rejectedUsers", nationalId), {
                                ...userData,
                                status: 'rejected',
                                reason: reason.trim(),
                                rejectedAt: serverTimestamp(),
                                lastUpdated: serverTimestamp()
                            });
                            
                            // Remove from pending users
                            await deleteDoc(doc(db, "pendingUsers", nationalId));
                            
                            showMessage('تم', 'تم رفض الطلب', 'success');
                            await loadAllData();
                            renderRequests();
                        }
                    } catch (error) {
                        console.error("خطأ في رفض الطلب:", error);
                        showMessage('خطأ', 'فشل في رفض الطلب', 'error');
                    }
                }
            } else if (reason !== null) {
                showMessage('مطلوب', 'يجب إدخال سبب الرفض', 'error');
            }
        }

        window.viewRequest = function(nationalId) {
            const request = allRequests.find(r => r.id === nationalId);
            if (request) {
                const details = `
تفاصيل الطلب:
================
الاسم: ${request.name || 'غير محدد'}
المهنة: ${request.job || 'غير محدد'}
المحافظة: ${request.city || 'غير محدد'}
الهاتف: ${request.phone || 'غير محدد'}
البريد: ${request.email || 'غير محدد'}
الرقم الوطني: ${request.nationalId || request.id}
الوصف: ${request.bio || 'لا يوجد وصف'}
تاريخ التقديم: ${formatDate(request.createdAt)}
الحالة: ${getStatusText(request.status)}
${request.reason ? `سبب الرفض: ${request.reason}` : ''}
                `;
                alert(details);
            } else {
                showMessage('خطأ', 'لم يتم العثور على الطلب', 'error');
            }
        }

        window.refreshData = async function() {
            showMessage('تحديث', 'جاري تحديث البيانات...', 'success');
            await loadAllData();
            renderRequests();
        }

        window.logout = function() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                sessionStorage.removeItem("adminLoggedIn");
                sessionStorage.removeItem("adminLoginTime");
                showMessage('تم', 'تم تسجيل الخروج بنجاح', 'success');
                setTimeout(() => {
                    window.location.href = 'admin-login.html';
                }, 1500);
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(async () => {
            try {
                await loadAllData();
                renderRequests();
                console.log('🔄 تحديث تلقائي للبيانات');
            } catch (error) {
                console.error('خطأ في التحديث التلقائي:', error);
            }
        }, 30000);

        console.log('✅ لوحة الإدارة جاهزة');
    </script>
</body>
</html>